<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ ê°•ì˜ ì–´ë•Œ? - ìœ íŠœë²„ ê°•ì˜ ì§„ì§œ í›„ê¸°</title>
    <style>
        * { box-sizing: border-box; }
        :root { --primary: #007bff; --neg: #ff4d4f; --pos: #52c41a; --neu: #8c8c8c; }
        body { font-family: -apple-system, sans-serif; background: #f8f9fa; margin: 0; color: #333; line-height: 1.5; overflow-x: hidden; }
        .container { max-width: 440px; margin: 0 auto; padding: 40px 20px; display: flex; flex-direction: column; width: 100%; }
        .logo-link { text-decoration: none; color: inherit; cursor: pointer; }
        .search-container { display: flex; gap: 8px; margin-bottom: 25px; width: 100%; }
        .search-input { flex: 1; padding: 15px 20px; border-radius: 30px; border: 2px solid var(--primary); outline: none; font-size: 15px; width: 100%; }
        .search-btn { background: var(--primary); color: white; border: none; padding: 0 22px; border-radius: 30px; cursor: pointer; font-weight: bold; flex-shrink: 0; }
        .summary-text-box { display: none; background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid #eee; font-size: 14px; line-height: 1.6; color: #444; }
        .summary-text-box b { color: var(--primary); }
        .creator-card, .course-card { background: white; border-radius: 24px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; width: 100%; overflow: hidden; }
        .creator-card { display: none; }
        .creator-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        /* ë§í¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .channel-link { font-size: 11px; color: var(--primary); text-decoration: none; border: 1px solid var(--primary); padding: 2px 8px; border-radius: 12px; margin-left: auto; font-weight: normal; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-item { background: #f8f9fa; padding: 15px 10px; border-radius: 16px; font-size: 12px; text-align: center; border: 1px solid #eee; color: #666; word-break: break-all; }
        .stat-item b { display: block; font-size: 18px; margin-top: 4px; color: #333; }
        .stat-sub { font-size: 10px; color: #999; margin-top: 4px; display: block; }
        .course-list-header { text-align: center; font-size: 14px; color: #666; margin: 35px 0 15px; display: none; font-weight: 500; }
        .course-card { border: 1px solid #eee; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .course-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; display: block; }
        .course-satisfaction { font-size: 18px; color: #f39c12; font-weight: bold; margin-bottom: 4px; }
        .help-box { background: #eef2f7; padding: 15px; border-radius: 14px; text-align: center; font-size: 14px; font-weight: bold; color: #333; margin: 15px 0; width: 100%; }
        .weighted-tag-box { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin: 15px 0; }
        .w-tag { font-size: 10px; font-weight: bold; padding: 6px 2px; border-radius: 8px; border: 1px solid; text-align: center; white-space: nowrap; display: flex; justify-content: center; align-items: center; }
        .w-tag.pos { background: #f6ffed; border-color: #b7eb8f; color: #52c41a; }
        .w-tag.neg { background: #fff1f0; border-color: #ffa39e; color: #ff4d4f; }
        .w-tag.neu { background: #f5f5f5; border-color: #d9d9d9; color: #333; }
        .review-toggle-btn { width: 100%; text-align: center; background: #f1f3f5; border: none; font-size: 14px; font-weight: bold; color: #495057; cursor: pointer; padding: 12px 0; border-radius: 12px; margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 6px; }
        .review-content-area { display: none; padding-top: 20px; border-top: 1px dashed #eee; margin-top: 15px; width: 100%; overflow: hidden; }
        .review-item { font-size: 14px; color: #444; margin-bottom: 18px; line-height: 1.6; word-break: break-all; }
        .review-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; width: 100%; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: flex-start; padding: 40px 20px; overflow-y: auto; }
        .modal-content { background: white; width: 100%; max-width: 380px; border-radius: 28px; padding: 25px; box-sizing: border-box; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 15px; }
        .tag-item { padding: 6px 10px; border-radius: 6px; border: 1px solid #eee; font-size: 11px; cursor: pointer; background: #fff; }
        .tag-item.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .write-btn { width: 100%; background: #1a1a1a; color: white; border: none; padding: 16px; border-radius: 14px; cursor: pointer; font-weight: bold; }
        .confirm-box { display: flex; align-items: flex-start; gap: 8px; margin-top: 15px; font-size: 11px; color: #666; cursor: pointer; line-height: 1.4; }
        .popup-guide-text { font-size: 13px; font-weight: bold; text-align: center; color: #555; margin: 0; }
        .footer { margin-top: auto; padding: 60px 0 40px; text-align: center; color: #999; font-size: 11px; line-height: 1.8; border-top: 1px solid #eee; width: 100%; }
        /* â”€â”€ í¬ë¦¬ì—ì´í„° ê³µì‹ ë‹µë³€ ë°•ìŠ¤ (ì ‘ê¸°/í¼ì¹˜ê¸°) â”€â”€ */
        .reply-section { margin-top: 20px; border-top: 1px dashed #e0e0e0; padding-top: 16px; }
        .reply-section-toggle { width: 100%; text-align: left; background: #f1f3f5; border: none; font-size: 13px; font-weight: bold; color: #495057; cursor: pointer; padding: 12px 14px; border-radius: 12px; display: flex; align-items: center; gap: 6px; }
        .reply-section-toggle:hover { background: #e9ecef; }
        .reply-section-toggle .arrow { font-size: 10px; color: #888; transition: transform 0.2s; }
        .reply-section-toggle.open .arrow { transform: rotate(90deg); }
        .reply-section-content { display: none; padding-top: 14px; }
        .reply-box { background: #f8faff; border: 1.5px solid #c7d7fd; border-radius: 14px; padding: 16px; }
        .reply-badge { font-size: 11px; font-weight: bold; color: #007bff; background: #dbeafe; padding: 3px 10px; border-radius: 20px; display: inline-block; margin-bottom: 10px; }
        .reply-text { font-size: 14px; color: #333; line-height: 1.75; white-space: pre-wrap; word-break: break-all; margin-bottom: 10px; }
        .reply-legal { font-size: 11px; color: #bbb; line-height: 1.6; border-top: 1px solid #e8eef8; padding-top: 10px; margin-top: 4px; }
        .reply-date { font-size: 11px; color: #aaa; margin-top: 6px; }
        .reply-empty { text-align: center; padding: 16px 0 4px; color: #aaa; font-size: 13px; line-height: 1.7; }
        .apply-btn { display: inline-block; margin-top: 10px; font-size: 12px; color: #007bff; background: none; border: 1px solid #007bff; border-radius: 20px; padding: 5px 14px; cursor: pointer; text-decoration: none; }
        .apply-form { display: none; margin-top: 14px; text-align: left; }
        .apply-input { width: 100%; padding: 11px 14px; border: 1.5px solid #ddd; border-radius: 10px; font-size: 13px; outline: none; margin-bottom: 8px; }
        .apply-input:focus { border-color: #007bff; }
        .apply-submit { width: 100%; background: #1a1a1a; color: white; border: none; padding: 12px; border-radius: 10px; font-size: 13px; font-weight: bold; cursor: pointer; }
        .apply-notice { font-size: 11px; color: #aaa; margin-top: 8px; line-height: 1.6; }
    </style>
</head>
<body>
<div class="container">
    <div style="text-align:center; padding-bottom: 30px;">
        <a href="/" class="logo-link">
            <h2 style="margin:0; font-size:24px;">ğŸ¤” ì´ ê°•ì˜ ì–´ë•Œ?</h2>
        </a>
        <p style="color:#666; font-size:14px; margin-top:8px;">ê´‘ê³  ë§ê³ , ì§„ì§œ ìˆ˜ê°•ìƒ í›„ê¸°ë§Œ ëª¨ì•˜ìŠµë‹ˆë‹¤.</p>
    </div>
    <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="ìœ íŠœë²„ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" onkeyup="if(window.event.keyCode==13){handleSearch()}">
        <button onclick="handleSearch()" class="search-btn">ê²€ìƒ‰</button>
    </div>
    <div id="dynamic-summary" class="summary-text-box"></div>
    <div id="creator-summary" class="creator-card"></div>
    <div id="course-list-title" class="course-list-header">â€œì•„ë˜ëŠ” ìœ„ í¬ë¦¬ì—ì´í„°ê°€ ìš´ì˜í•˜ëŠ” ê°•ì˜ ëª©ë¡ì…ë‹ˆë‹¤â€</div>
    <div id="course-list"></div>
    <div class="footer">
        ë³¸ ì„œë¹„ìŠ¤ëŠ” ê°œì¸ì˜ ê²½í—˜ì„ ê³µìœ í•˜ëŠ” ì •ë³´ í”Œë«í¼ì…ë‹ˆë‹¤.<br>
        ì½˜í…ì¸ ì˜ ì‚¬ì‹¤ ì—¬ë¶€ ë° í•´ì„ì— ëŒ€í•œ ì±…ì„ì€ ì‘ì„±ìì—ê²Œ ìˆìœ¼ë©°,<br>
        í—ˆìœ„Â·ë¹„ë°©Â·ê¶Œë¦¬ ì¹¨í•´ ëª©ì ì˜ ê²Œì‹œë¬¼ì€ ì‚­ì œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><br>
        ë¬¸ì˜: <a href="mailto:remoney8080@gmail.com" style="color:#999; text-decoration: underline;">remoney8080@gmail.com</a>
    </div>
</div>

<div id="review-modal" class="modal">
    <div class="modal-content">
        <div id="step1">
            <h3 style="text-align:center; margin-bottom:15px; font-size:18px;">ê°•ì˜ í›„ê¸° ë‚¨ê¸°ê¸°</h3>
            <div id="star-rating" style="font-size:35px; text-align:center; cursor:pointer; margin-bottom:2px; color:#f39c12;">
                <span onclick="setRate(1)">â˜…</span><span onclick="setRate(2)">â˜…</span><span onclick="setRate(3)">â˜…</span><span onclick="setRate(4)">â˜…</span><span onclick="setRate(5)" style="color:#ddd;">â˜†</span>
            </div>
            <p class="popup-guide-text" style="margin-bottom: 12px;">â­ ë³„ì  ì„ íƒ í›„</p>
            <p class="popup-guide-text" style="margin-bottom: 8px;">ğŸ‘ ì¶”ì²œ ì—¬ë¶€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button id="btn-y" style="flex:1; padding:12px; border-radius:12px; border:1px solid #eee; background:#fff; font-weight:bold; font-size:14px;" onclick="setHelpful(true)">ğŸ‘ ì˜ˆ</button>
                <button id="btn-n" style="flex:1; padding:12px; border-radius:12px; border:1px solid #eee; background:#fff; font-weight:bold; font-size:14px;" onclick="setHelpful(false)">ğŸ‘ ì•„ë‹ˆì˜¤</button>
            </div>
            <p style="font-size:13px; font-weight:bold; margin-bottom:8px; color:#333;">ì´ ê°•ì˜ì— ëŒ€í•œ ê°œì¸ì ì¸ í•œë§ˆë””</p>
            <textarea id="review-text" maxlength="200" style="width:100%; height:110px; padding:15px; border-radius:12px; border:1px solid #ddd; box-sizing:border-box; font-size:14px; outline:none;" placeholder="ê°œì¸ì ì¸ í•œë§ˆë””ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”"></textarea>
            <label class="confirm-box"><input type="checkbox" id="confirm-check"><span style="font-size:11px; color:#666;">ë³¸ í›„ê¸°ëŠ” ê°œì¸ ê²½í—˜ì´ë©°, í—ˆìœ„ ì‚¬ì‹¤ì´ë‚˜ ë¹„ë°© ëª©ì ì´ ì•„ë‹˜ì„ í™•ì¸í•¨.</span></label>
            <button class="write-btn" style="background:var(--primary); margin-top:15px;" onclick="goStep2()">ë‹¤ìŒ: íƒœê·¸ ì„ íƒ (ìµœì†Œ 3ê°œ) â¡ï¸</button>
        </div>
        <div id="step2" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">ìƒì„¸ íƒœê·¸ ì„ íƒ</h3>
                <span id="count-display" style="font-size:12px; font-weight:bold; color:var(--primary);">0 / 8</span>
            </div>
            <div id="tag-lists"></div>
            <button class="write-btn" style="margin-top:20px;" onclick="submitFinal()">ìµœì¢… í›„ê¸° ë“±ë¡ ì™„ë£Œ ğŸš€</button>
            <div style="text-align:center; margin-top:20px;"><span style="font-size:13px; color:#999; cursor:pointer; text-decoration:underline;" onclick="goStep1()">â¬…ï¸ ì´ì „ ë‹¨ê³„ë¡œ ëŒì•„ê°€ê¸°</span></div>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://tctogguvgwvkxpymdsmn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjdG9nZ3V2Z3d2a3hweW1kc21uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNzA0MzQsImV4cCI6MjA4MzY0NjQzNH0.sd54qY83b09GmsIKVWCB7IkjLrC1vePrhbhPHKnQazE';
    const headers = { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY, 'Content-Type': 'application/json' };
    
    let reviewData = { cid: '', rate: 4, help: null, tags: [] };
    const forbiddenWords = ["ì‚¬ê¸°", "ë¶ˆë²•", "ê³ ì˜", "ë²”ì£„", "ì‹ ê³ ", "ë¨¹íŠ€", "18", "ê°œìƒˆë¼", "ì‚¬ê¸°ê¾¼", "100%ë³´ì¥", "ë¬´ì¡°ê±´", "ì ˆëŒ€"];

    const posTags = ['ì‹¤ì „ì ìš©ê°€ëŠ¥', 'ê°•ì‚¬ì‘ë‹µë¹ ë¦„', 'ì¬ìˆ˜ê°•ì˜ì‚¬', 'ì´ˆë³´ì¶”ì²œ', 'ì™„ì „ì¶”ì²œ', 'ì´í•´ì˜ë¨', 'ì„¤ëª…ëª…í™•', 'ì˜ˆì œí’ë¶€', 'ë°”ë¡œì¨ë¨¹ìŒ', 'ì»¤ë¦¬í˜ëŸ¼íƒ„íƒ„', 'í”¼ë“œë°±ì¢‹ìŒ', 'ìµœì‹ íŠ¸ë Œë“œë°˜ì˜', 'ë¹„ì „ê³µìë„ì´í•´', 'ê°€ì„±ë¹„ì¢‹ìŒ', 'ì‹¤ë¬´ìì¶”ì²œ'];
    const negTags = ['ê°•ì˜ë£Œë¹„ìŒˆ', 'ë‚´ìš©ë¹ˆì•½', 'í™˜ë¶ˆê´€ë ¨ì•„ì‰¬ì›€', 'ì‹œê°„ë‚­ë¹„', 'ì„¤ëª…ë¶ˆì¹œì ˆ', 'ê°•ì˜êµ¬ì„±ë¶ˆë§Œì¡±', 'ê´‘ê³ ê¸°ëŒ€ì™€ì°¨ì´', 'í™ë³´ì™€ì²´ê°ì°¨ì´', 'ì§ˆë¬¸ë‹µë³€ì—†ìŒ', 'ê¸°ì¡´ìë£Œí™œìš©', 'ì‹¤ìŠµë¶€ì¡±', 'ì˜ìƒì•„ì‰¬ì›€', 'ìŒì§ˆì•„ì‰¬ì›€', 'ì´ˆë³´ì—ê²ì–´ë ¤ì›€', 'ìë£Œë‹¨ìˆœí•¨'];
    const neuTags = ['ê¸°ì´ˆìœ„ì£¼', 'ìœ íŠœë¸Œì™€ì¤‘ë³µ', 'ê³ ê¸‰ê³¼ì •', 'ì§§ì€ê¸¸ì´', 'ìë£Œí’ë¶€', 'ì´ë¡ ìœ„ì£¼', 'ì‹¤ìŠµìœ„ì£¼', 'í”„ë¡œì íŠ¸ê¸°ë°˜', 'ì§§ê³ êµµìŒ', 'ê¸´ê°•ì˜', 'ë‚œì´ë„ë†’ìŒ', 'ì…ë¬¸ììš©', 'ì¤‘ê¸‰ììš©', 'ì‹¤ë¬´ììš©', 'ìµœì‹ ì—…ë°ì´íŠ¸ì—†ìŒ', 'ìë£Œë‹¤ìš´ë¡œë“œì œê³µ', 'ì»¤ë®¤ë‹ˆí‹°ìˆìŒ'];

    async function handleSearch() {
        const val = document.getElementById('search-input').value.trim();
        if(!val) return;
        const res = await fetch(`${SUPABASE_URL}/rest/v1/creator_stats?creator_name=ilike.*${val}*&select=*`, { headers });
        const stats = await res.json();
        const summary = document.getElementById('creator-summary');
        const listHeader = document.getElementById('course-list-title');
        const courseList = document.getElementById('course-list');
        const dynamicSummary = document.getElementById('dynamic-summary');
        
        if(stats.length > 0) {
            const s = stats[0]; 
            summary.style.display = 'block'; 
            listHeader.style.display = 'block';
            /* ìˆ˜ì •ëœ ë¶€ë¶„: ì±„ë„ ë§í¬ê°€ ìˆì„ ë•Œë§Œ ğŸ”— ë²„íŠ¼ ë…¸ì¶œ */
            summary.innerHTML = `
                <div class="creator-header">
                    ğŸ‘¤ ìœ íŠœë²„: ${s.creator_name}
                    ${s.link_url ? `<a href="${s.link_url}" target="_blank" class="channel-link">ğŸ”— ì±„ë„ë³´ê¸°</a>` : ''}
                </div>
                <div class="stats-grid">
                    <div class="stat-item">êµ¬ë…ì<b>${s.subscribers}</b><span class="stat-sub">(${s.updated_at || '26ë…„ 1ì›”'} ê¸°ì¤€)</span></div>
                    <div class="stat-item">ë“±ë¡ ê°•ì˜ ìˆ˜<b>1ê°œ</b></div>
                    <div class="stat-item">ì´ í›„ê¸°<b>${s.total_reviews}ê°œ</b><span class="stat-sub" style="color:#999; font-weight:bold;">í›„ê¸° 10ê°œ ë¯¸ë§Œì€ ì°¸ê³ ìš©</span></div>
                    <div class="stat-item">í‰ê·  ë§Œì¡±ë„<b>${Number(s.avg_rating || 0).toFixed(1)} / 5</b><span class="stat-sub">(ê°œì¸ ê²½í—˜ ê¸°ë°˜)</span></div>
                </div>`;
            fetchCourses(s.creator_id, s.creator_name, s.total_reviews);
        } else {
            summary.style.display = 'none'; 
            listHeader.style.display = 'none'; 
            dynamicSummary.style.display = 'none';
            courseList.innerHTML = `<div style="text-align:center; padding:60px 20px; color:#666; line-height:1.6;"><b>ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</b><br>í¬ë¦¬ì—ì´í„°ì™€ ê°•ì˜ ì •ë³´ë¥¼ ë©”ì¼ë¡œ ì—…ë°ì´íŠ¸ ìš”ì²­í•´ì£¼ì„¸ìš”.<br><br><a href="mailto:remoney8080@gmail.com" style="color:var(--primary); font-weight:bold;">remoney8080@gmail.com</a></div>`;
        }
    }

    async function fetchCourses(creatorId, creatorName, totalReviews) {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/get_course_stats`, { method: 'POST', headers, body: JSON.stringify({ target_creator_id: creatorId })});
        const courses = await res.json();
        const list = document.getElementById('course-list');
        const dynamicSummary = document.getElementById('dynamic-summary');
        list.innerHTML = '';
        let allTags = {};

        for (const c of courses) {
            const revRes = await fetch(`${SUPABASE_URL}/rest/v1/reviews?course_id=eq.${c.id}&select=content,rating,tags&order=created_at.desc`, { headers });
            const reviews = await revRes.json();
            let creatorReply = null;
            try {
                const replyRes = await fetch(`${SUPABASE_URL}/rest/v1/rpc/get_creator_response`, { method: 'POST', headers, body: JSON.stringify({ target_course_id: c.id }) });
                const replyRows = await replyRes.json();
                const row = Array.isArray(replyRows) ? replyRows[0] : replyRows;
                if (row && row.content) creatorReply = row;
            } catch (_) { /* RPC ì‹¤íŒ¨ ì‹œ ì‹ ì²­ ë²„íŠ¼ë§Œ í‘œì‹œ */ }
            let tagCalc = {};
            reviews.forEach(r => {
                if(r.tags) r.tags.forEach(t => {
                    if(!tagCalc[t]) tagCalc[t] = { score: 0, count: 0, type: 'neu' };
                    let w = 0.7;
                    if(posTags.includes(t)) { w = 1.0; tagCalc[t].type = 'pos'; }
                    else if(negTags.includes(t)) { w = 1.3; tagCalc[t].type = 'neg'; }
                    tagCalc[t].score += w;
                    tagCalc[t].count += 1;
                    allTags[t] = (allTags[t] || 0) + 1;
                });
            });

            const topTags = Object.entries(allTags).sort((a,b) => b[1] - a[1]).slice(0, 3).map(t => t[0]);
            if (totalReviews > 0 && topTags.length > 0) {
                dynamicSummary.style.display = 'block';
                dynamicSummary.innerHTML = `ê²€ìƒ‰í•˜ì‹  <b>${creatorName}</b> ë‹˜ì˜ ê°•ì˜ëŠ” í˜„ì¬ê¹Œì§€ ì´ <b>${totalReviews}ê°œ</b>ì˜ ì‹¤ì œ ìˆ˜ê°•ìƒ í›„ê¸°ê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìˆ˜ê°•ìƒë“¤ì€ ì£¼ë¡œ <b>#${topTags.join(', #')}</b> ë“±ì˜ í‚¤ì›Œë“œë¥¼ ê°€ì¥ ë§ì´ ì–¸ê¸‰í•˜ê³  ìˆìŠµë‹ˆë‹¤. ê´‘ê³  ì—†ëŠ” ì§„ì§œ í›„ê¸°ë¥¼ ì•„ë˜ì—ì„œ í™•ì¸í•´ë³´ì„¸ìš”.`;
            } else {
                dynamicSummary.style.display = 'none';
            }

            const replyHtml = creatorReply
              ? `<div class="reply-box"><span class="reply-badge">ğŸ™ í¬ë¦¬ì—ì´í„° ê³µì‹ ë‹µë³€ Â· ë³¸ì¸ ì¸ì¦ ì™„ë£Œ</span><div class="reply-text">${(creatorReply.content || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div><div class="reply-date">${new Date(creatorReply.created_at).toLocaleDateString('ko-KR')} ë“±ë¡</div><div class="reply-legal">ë³¸ ë‹µë³€ì€ í¬ë¦¬ì—ì´í„°ê°€ ì§ì ‘ ë“±ë¡í•œ ê³µì‹ ì…ì¥ì…ë‹ˆë‹¤.<br>ìš´ì˜ìëŠ” ë‚´ìš©ì˜ ì‚¬ì‹¤ ì—¬ë¶€ë¥¼ ë³´ì¦í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div></div>`
              : `<div class="reply-empty">í˜„ì¬ ë“±ë¡ëœ ê³µì‹ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.<br><button class="apply-btn" onclick="toggleApplyForm('${c.id}')">í¬ë¦¬ì—ì´í„°ì´ì‹ ê°€ìš”? ë‹µë³€ ë“±ë¡ ì‹ ì²­</button><div class="apply-form" id="apply-form-${c.id}"><input class="apply-input" id="apply-email-${c.id}" type="email" placeholder="ë¹„ì¦ˆë‹ˆìŠ¤ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" /><button class="apply-submit" onclick="submitApplication('${c.id}')">ì‹ ì²­í•˜ê¸°</button><div class="apply-notice">ìš´ì˜íŒ€ì´ í™•ì¸ í›„ ì…ë ¥í•˜ì‹  ë©”ì¼ë¡œ ë‹µë³€ ë§í¬ë¥¼ ë°œì†¡ë“œë¦½ë‹ˆë‹¤.<br>í†µìƒ 1~2 ì˜ì—…ì¼ ë‚´ ì²˜ë¦¬ë©ë‹ˆë‹¤.</div></div></div>`;
            const replySectionHtml = `<div class="reply-section"><button type="button" class="reply-section-toggle" id="reply-toggle-${c.id}" onclick="toggleReplySection('${c.id}')" aria-expanded="false"><span class="arrow">â–¶</span> ğŸ™ í¬ë¦¬ì—ì´í„° ê³µì‹ ë‹µë³€</button><div class="reply-section-content" id="reply-content-${c.id}">${replyHtml}</div></div>`;
            const top4 = Object.entries(tagCalc).sort((a,b) => b[1].score - a[1].score).slice(0, 4);
            const tagHtml = top4.map(([name, info]) => `<span class="w-tag ${info.type}">${name} ${info.count}</span>`).join('');
            let reviewsHtml = reviews.map(r => {
                const tagsInside = (r.tags || []).map(t => {
                    let tType = 'neu';
                    if(posTags.includes(t)) tType = 'pos';
                    else if(negTags.includes(t)) tType = 'neg';
                    return `<span class="w-tag ${tType}" style="display:inline-block; margin:2px; padding:2px 8px; font-size:10px;">#${t}</span>`;
                }).join('');
                return `<div class="review-item" style="border-bottom:1px solid #eee; padding-bottom:12px; margin-bottom:12px;"><b>ğŸ—¨ï¸ â€œ${r.content}â€</b><div class="review-tags">${tagsInside}</div></div>`;
            }).join('');
            
            list.insertAdjacentHTML('beforeend', `
                <div class="course-card">
                    <strong class="course-title">${c.title}</strong>
                    <div class="course-satisfaction">í‰ê·  ë§Œì¡±ë„: â­ ${Number(c.avg_rating || 0).toFixed(1)} / ${c.review_count}ëª…</div>
                    <div class="help-box">ë„ì›€ë¨ ğŸ‘ (${c.recommend_rate || 0}%) &nbsp;&nbsp; ë„ì›€ì•ˆë¨ ğŸ‘ (${100-(c.recommend_rate||0)}%)</div>
                    <div class="weighted-tag-box">${tagHtml}</div>
                    <button class="write-btn" style="background:#1a1a1a;" onclick="openModal('${c.id}')">ğŸ¤ ì´ ê°•ì˜ í›„ê¸° ë‚¨ê¸°ê¸°</button>
                    ${replySectionHtml}
                    <button class="review-toggle-btn" onclick="toggleReviews('${c.id}')">ğŸ“‚ ìˆ˜ê°•ìƒ í›„ê¸° ë³´ê¸° (${c.review_count})</button>
                    <div id="reviews-${c.id}" class="review-content-area">${reviewsHtml || 'ì²« í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.'}</div>
                </div>`);
        }
    }

    function toggleReviews(id) {
        const area = document.getElementById(`reviews-${id}`);
        area.style.display = area.style.display === 'block' ? 'none' : 'block';
    }
    function toggleReplySection(id) {
        const content = document.getElementById(`reply-content-${id}`);
        const btn = document.getElementById(`reply-toggle-${id}`);
        const isOpen = content.style.display === 'block';
        content.style.display = isOpen ? 'none' : 'block';
        if (btn) btn.classList.toggle('open', !isOpen);
        if (btn) btn.setAttribute('aria-expanded', !isOpen);
    }

    function openModal(id) { reviewData.cid = id; reviewData.help = null; document.getElementById('review-modal').style.display = 'flex'; setRate(4); }
    function goStep1() { document.getElementById('step2').style.display = 'none'; document.getElementById('step1').style.display = 'block'; }
    function setRate(r) { reviewData.rate = r; document.querySelectorAll('#star-rating span').forEach((s, i) => s.style.color = i < r ? '#f39c12' : '#ddd'); }
    function setHelpful(v) { reviewData.help = v; document.getElementById('btn-y').style.borderColor = v ? 'var(--primary)' : '#eee'; document.getElementById('btn-n').style.borderColor = !v ? 'var(--neg)' : '#eee'; }
    
    function goStep2() {
        const text = document.getElementById('review-text').value;
        const foundWords = forbiddenWords.filter(w => text.includes(w));
        if(foundWords.length > 0) {
            return alert("ì‚¬ê¸°, ë¶ˆë²•, ê³ ì˜, ë²”ì£„, ì‹ ê³ , ë¨¹íŠ€ ë“±ì˜ ë¶€ì ì ˆí•œ ë‹¨ì–´ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê°œì¸ê²½í—˜ ì¤‘ì‹¬ìœ¼ë¡œ ìˆ˜ì •í•´ì£¼ì„¸ìš”. (ì‹¤ì œ í”¼í•´ë¥¼ ë‹¹í•œ ê²½ìš°ëŠ” ê³µì •ìœ„ë‚˜ ì†Œë³´ì›ì— ë¬¸ì˜í•˜ì„¸ìš”.)");
        }
        if(!text || reviewData.help === null || !document.getElementById('confirm-check').checked) return alert("í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        document.getElementById('step1').style.display = 'none'; document.getElementById('step2').style.display = 'block'; renderTags();
    }

    function renderTags() {
        const tagDict = { pos: posTags, neg: negTags, neu: neuTags };
        const draw = (l, list, c) => `<div style="color:${c}; font-size:11px; font-weight:bold; margin:10px 0 5px;">${l}</div><div class="tag-container">${list.map(t => `<div class="tag-item" onclick="toggleTag(this, '${t}')">#${t}</div>`).join('')}</div>`;
        document.getElementById('tag-lists').innerHTML = draw('ğŸŸ¢ ê¸ì • íƒœê·¸', tagDict.pos, 'var(--pos)') + draw('ğŸ”´ ë¶€ì • íƒœê·¸', tagDict.neg, 'var(--neg)') + draw('âšª ì¤‘ë¦½/ê¸°íƒ€', tagDict.neu, 'var(--neu)');
    }

    function toggleTag(el, t) {
        if(reviewData.tags.includes(t)) { reviewData.tags = reviewData.tags.filter(i => i !== t); el.classList.remove('selected'); }
        else { 
            if(reviewData.tags.length >= 8) { alert("ìµœëŒ€ 8ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
            reviewData.tags.push(t); el.classList.add('selected'); 
        }
        document.getElementById('count-display').innerText = `${reviewData.tags.length} / 8`;
    }

    async function submitFinal() {
        if(reviewData.tags.length < 3) return alert("íƒœê·¸ë¥¼ ìµœì†Œ 3ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
        const res = await fetch(`${SUPABASE_URL}/rest/v1/reviews`, { method: 'POST', headers, body: JSON.stringify({ course_id: reviewData.cid, rating: reviewData.rate, is_helpful: reviewData.help, content: document.getElementById('review-text').value, tags: reviewData.tags }) });
        if(res.ok) { alert("ë“±ë¡ ì™„ë£Œ!"); location.reload(); }
    }

    function toggleApplyForm(courseId) {
        const form = document.getElementById(`apply-form-${courseId}`);
        form.style.display = form.style.display === 'block' ? 'none' : 'block';
    }
    async function submitApplication(courseId) {
        const email = document.getElementById(`apply-email-${courseId}`).value.trim();
        if (!email || !email.includes('@')) { alert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        const res = await fetch(`${SUPABASE_URL}/rest/v1/creator_applications`, { method: 'POST', headers, body: JSON.stringify({ course_id: courseId, email }) });
        if (res.status === 201) {
            document.getElementById(`apply-form-${courseId}`).innerHTML = `<div style="text-align:center; color:#52c41a; font-size:13px; padding:8px 0;">âœ… ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.<br><span style="color:#aaa; font-size:11px;">ìš´ì˜íŒ€ í™•ì¸ í›„ ë©”ì¼ë¡œ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.</span></div>`;
        } else {
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    }
</script>
</body>
</html>