# 여러 유튜버 한 시나리오로 — 가이드

> 채널 목록을 DB에 두고, Make 시나리오 하나가 모든 채널을 돌면서 강의를 수집하는 구조입니다.  
> **당신은 엑셀(CSV)만 채워서 주면 되고, Cursor/스크립트가 creators + youtube_channels 에 등록합니다.**

---

## 순서 요약

1. **(한 번만)** Supabase에 `youtube_channels` 테이블 만들기  
2. **샘플 CSV** 받아서 → **name, subscribers, sub_count_date, link_url, youtube_channel_id** 채우기 (처음 30명 등)  
3. **스크립트** 실행 → CSV 한 번에 **creators** + **youtube_channels** 등록 (creator_id 자동 생성)  
4. **Make.com** 시나리오 수정 (채널 목록 조회 → 채널별 API → Insert)  
5. **이후** 추가 유튜버는 같은 CSV 형식으로 채워서 스크립트만 다시 실행하면 됨  

---

## 0. 엑셀(CSV) 샘플 받기

프로젝트에 **`docs/creators_upload_샘플.csv`** 파일이 있습니다.

| 컬럼 | 설명 |
|------|------|
| name | 유튜버 이름 (사이트에 표시되는 이름) |
| subscribers | 구독자 수 (숫자만) |
| sub_count_date | 구독자 수 기준일 (예: 2026-01-15) |
| link_url | 채널 링크 (예: https://www.youtube.com/@채널명) |
| youtube_channel_id | **UC로 시작하는 채널 ID** (Make.com·API용, 여기 필수) |

- **엑셀**에서 이 CSV를 열어서 **아래 행만 채우면** 됩니다. (첫 줄은 헤더 그대로 두기)  
- **youtube_channel_id** 찾는 법: 유튜브 채널 페이지 주소가 `youtube.com/channel/UCxxxx...` 이면 그 **UCxxxx...** 전체. 또는 채널 페이지 → 우클릭 → 페이지 소스 보기 → `"channelId":"UC...` 검색.

**저장 시:** CSV(쉼표로 구분) 또는 UTF-8 CSV로 저장. (한글 깨지지 않게 UTF-8 권장)

---

## 1. Supabase: youtube_channels 테이블 (한 번만)

Supabase **SQL Editor**에서 아래만 실행하세요.

```sql
CREATE TABLE IF NOT EXISTS public.youtube_channels (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  creator_id UUID NOT NULL,
  youtube_channel_id TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(creator_id, youtube_channel_id)
);

ALTER TABLE public.youtube_channels ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow read youtube_channels"
  ON public.youtube_channels
  FOR SELECT
  USING (true);
```

이후 **creators / youtube_channels** 에 데이터 넣는 건 **스크립트**가 합니다.

---

## 2. CSV 채우기 → 스크립트로 일괄 등록

### 2-1. creators 테이블 컬럼 확인

Supabase **Table Editor → creators** 에서 **실제 컬럼 이름**을 확인하세요.  
(예: `name` vs `creator_name`, `sub_count_date` vs `updated_at` 등)

스크립트 기본값은 **name, subscribers, sub_count_date, link_url** 입니다.  
다르면 **`automation/upload_creators_and_channels.py`** 상단의 **CREATORS_COLUMNS** 를 실제 컬럼명에 맞게 수정하세요.

### 2-2. 스크립트 실행

터미널에서 (CSV 경로는 본인이 채운 파일로 바꾸세요):

```bash
# .env 에 SUPABASE_URL, SUPABASE_SERVICE_KEY 가 있으면 로드 후
python automation/upload_creators_and_channels.py docs/내가_채운_크리에이터목록.csv
```

- **creators** 에 행이 하나씩 들어가고, 새로 생긴 **id** 로 **youtube_channels** 에 (creator_id, youtube_channel_id) 가 들어갑니다.  
- 에러가 나면 메시지 보고 CSV·컬럼명을 맞추면 됩니다.

### 2-3. 추가분이 생기면

같은 CSV 형식으로 **추가분만** 넣은 새 CSV를 만들고, 같은 명령으로 다시 실행하면 됩니다.  
(처음 30명 → 나중에 10명 더 → 또 20명 더 … 식으로)

---

## 3. Make.com 시나리오 수정 (채널 목록 → 채널별 API → Insert)

이제 **youtube_channels** 에 행이 있으니**, Make가 이 테이블을 읽어서 채널별로 API 호출**하도록 바꿉니다.

### 3-1. 전체 흐름 (수정 후)

```
[스케줄 또는 Webhook]
    ↓
[Supabase - Search rows]  ← youtube_channels 전체 조회
    ↓
[Iterator]  ← 채널 행 하나씩
    ↓
[HTTP - Make a request]   ← channelId = 현재 행의 youtube_channel_id
    ↓
[Iterator]  ← 영상 목록(items)
    ↓
[Filter]    ← 제목에 강의/클래스/오픈
    ↓
[Supabase - Create a row] ← courses Insert, creator_id = 현재 행의 creator_id
```

### 3-2. 수정 단계

1. 트리거 다음에 **Supabase - Search rows** 추가 → Table: `youtube_channels`, Limit: 100  
2. **Iterator** 추가 → Array: Supabase 출력의 배열  
3. **HTTP** 모듈에서 **channelId** 를 **매핑** → Iterator의 `youtube_channel_id`  
4. **Supabase Create a row (courses)** 에서 **creator_id** 를 **매핑** → Iterator의 `creator_id`  
5. 저장 후 Webhook 호출 또는 Run once 로 테스트

---

## 4. 체크리스트

- [ ] Supabase `youtube_channels` 테이블 생성 (1번)
- [ ] 샘플 CSV 복사 후 name, subscribers, sub_count_date, link_url, **youtube_channel_id** 채우기 (처음 30명 등)
- [ ] creators 테이블 컬럼명 확인 후 스크립트 CREATORS_COLUMNS 필요 시 수정
- [ ] `upload_creators_and_channels.py` 실행 → creators + youtube_channels 등록
- [ ] Make: Search rows(youtube_channels) → Iterator → HTTP(channelId 매핑) → Insert(creator_id 매핑)
- [ ] Webhook/Run once 테스트
- [ ] 이후 추가분은 같은 CSV 형식으로 채워서 스크립트만 다시 실행

---

이후에는 **엑셀(CSV)만 채워서 주고 → 스크립트 한 번 실행**하면 새 유튜버가 사이트·Make 모두에 반영됩니다.

---

## 5. (보조) Make 대신 로컬에서 강의 수집 — fetch_youtube_courses.py

Make.com 실행이 안 되거나 강의가 0건일 때, **로컬 스크립트**로 같은 동작을 할 수 있습니다.

1. **.env** 에 **YOUTUBE_API_KEY** 추가 (Google Cloud에서 발급한 YouTube Data API v3 키).
2. 터미널에서:
   ```bash
   cd /Users/gimmingyu/Desktop/2025/igangwhat
   source .venv/bin/activate
   python automation/fetch_youtube_courses.py
   ```
3. `youtube_channels` 의 채널마다 YouTube API로 최신 영상을 가져와, 제목에 **강의/클래스/오픈**이 있는 것만 **courses** 에 넣습니다.
4. **한 건도 안 들어가면** (제목에 키워드가 없을 때): `automation/fetch_youtube_courses.py` 안에서 **TITLE_KEYWORDS = []** 로 바꾼 뒤 다시 실행하면, 키워드 없이 **모든 최신 영상**이 강의로 들어갑니다.

이 스크립트로 강의가 들어가는 걸 확인한 뒤, Make.com은 스케줄용으로만 쓰면 됩니다.
